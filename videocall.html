<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VideoCall - Connect with Anyone</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            max-width: 1200px;
            width: 90%;
        }

        .header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .header h1 {
            color: #333;
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .header p {
            color: #666;
            font-size: 1.1rem;
        }

        .main-content {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .role-selection {
            display: flex;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .role-card {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            min-width: 200px;
        }

        .role-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border-color: #667eea;
        }

        .role-card.active {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .role-card h3 {
            margin-bottom: 1rem;
            font-size: 1.3rem;
        }

        .role-card p {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .meeting-form {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
            width: 100%;
            max-width: 400px;
            display: none;
        }

        .meeting-form.active {
            display: block;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #333;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 0.8rem;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 25px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .meeting-info {
            background: #e8f4fd;
            border-radius: 10px;
            padding: 1rem;
            margin: 1rem 0;
            text-align: center;
            display: none;
        }

        .meeting-info.active {
            display: block;
        }

        .meeting-id {
            font-size: 1.2rem;
            font-weight: bold;
            color: #667eea;
            margin: 0.5rem 0;
        }

        .video-container {
            display: none;
            width: 100%;
            max-width: 1000px;
            margin-top: 2rem;
        }

        .video-container.active {
            display: block;
        }

        .video-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .video-wrapper {
            position: relative;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
        }

        .video-wrapper video {
            width: 100%;
            height: 300px;
            object-fit: cover;
        }

        .video-label {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 0.3rem 0.8rem;
            border-radius: 15px;
            font-size: 0.9rem;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 1rem;
        }

        .control-btn {
            background: #333;
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .control-btn:hover {
            background: #555;
        }

        .control-btn.danger {
            background: #e74c3c;
        }

        .control-btn.danger:hover {
            background: #c0392b;
        }

        .participants {
            background: white;
            border-radius: 10px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .participants h3 {
            margin-bottom: 0.5rem;
            color: #333;
        }

        .participant-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .participant {
            background: #f8f9fa;
            padding: 0.3rem 0.8rem;
            border-radius: 15px;
            font-size: 0.9rem;
            color: #666;
        }

        .connection-status {
            margin-top: 1rem;
            padding: 0.8rem;
            background: #f0f8ff;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }

        .connection-status p {
            margin: 0;
            font-size: 0.9rem;
            color: #333;
        }

        .debug-panel {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 1rem;
            margin-top: 1rem;
            border: 1px solid #e0e0e0;
        }

        .debug-panel h3 {
            margin-bottom: 0.5rem;
            color: #333;
            font-size: 1rem;
        }

        .debug-panel p {
            margin: 0.5rem 0;
            font-size: 0.9rem;
        }

        #meetingsList {
            background: white;
            border-radius: 5px;
            padding: 0.5rem;
            margin-top: 0.5rem;
            font-family: monospace;
            font-size: 0.8rem;
            max-height: 150px;
            overflow-y: auto;
            display: none;
        }

        .status {
            text-align: center;
            margin: 1rem 0;
            padding: 0.8rem;
            border-radius: 8px;
            display: none;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            display: block;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            display: block;
        }

        .status.info {
            background: #cce7ff;
            color: #004085;
            display: block;
        }

        @media (max-width: 768px) {
            .role-selection {
                flex-direction: column;
                gap: 1rem;
            }

            .video-grid {
                grid-template-columns: 1fr;
            }

            .controls {
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>VideoCall</h1>
            <p>Connect with anyone, anywhere</p>
        </div>

        <div class="main-content">
            <div class="status" id="status"></div>

            <div class="role-selection" id="roleSelection">
                <div class="role-card" id="hostCard">
                    <h3>🎯 Host Meeting</h3>
                    <p>Create a new meeting and invite participants</p>
                </div>
                <div class="role-card" id="joinCard">
                    <h3>🚀 Join Meeting</h3>
                    <p>Enter meeting ID to join an existing meeting</p>
                </div>
            </div>

            <div class="meeting-form" id="hostForm">
                <div class="form-group">
                    <label for="hostName">Your Name</label>
                    <input type="text" id="hostName" placeholder="Enter your name">
                </div>
                <button class="btn" id="createMeetingBtn">Create Meeting</button>
            </div>

            <div class="meeting-form" id="joinForm">
                <div class="form-group">
                    <label for="participantName">Your Name</label>
                    <input type="text" id="participantName" placeholder="Enter your name">
                </div>
                <div class="form-group">
                    <label for="meetingId">Meeting ID</label>
                    <input type="text" id="meetingId" placeholder="Enter meeting ID">
                </div>
                <button class="btn" id="joinMeetingBtn">Join Meeting</button>
            </div>

            <div class="meeting-info" id="meetingInfo">
                <h3>Meeting Created Successfully!</h3>
                <p>Share this Meeting ID with participants:</p>
                <div class="meeting-id" id="displayMeetingId"></div>
                <button class="btn" id="startCallBtn">Start Video Call</button>
            </div>

            <div class="video-container" id="videoContainer">
                <div class="video-grid">
                    <div class="video-wrapper">
                        <video id="localVideo" autoplay muted></video>
                        <div class="video-label">You</div>
                    </div>
                    <div class="video-wrapper">
                        <video id="remoteVideo" autoplay></video>
                        <div class="video-label" id="remoteLabel">Waiting for participant...</div>
                    </div>
                </div>

                <div class="controls">
                    <button class="control-btn" id="toggleVideo">📹 Video</button>
                    <button class="control-btn" id="toggleAudio">🎤 Audio</button>
                    <button class="control-btn danger" id="endCall">📞 End Call</button>
                </div>

                <div class="participants">
                    <h3>Participants</h3>
                    <div class="participant-list" id="participantList">
                        <div class="participant">You (<span id="yourRole">Host</span>)</div>
                    </div>
                    <div class="connection-status" id="connectionStatus">
                        <p>🔄 Waiting for connection...</p>
                    </div>
                </div>

                <!-- Debug Panel -->
                <div class="debug-panel" id="debugPanel">
                    <h3>🔧 Debug Tools</h3>
                    <p><strong>Active Meetings:</strong> <span id="activeMeetings">0</span></p>
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin: 0.5rem 0;">
                        <button class="control-btn" id="showMeetingsBtn">Show All Meetings</button>
                        <button class="control-btn" id="createTestMeetingBtn">Create Test Meeting</button>
                        <button class="control-btn danger" id="clearMeetingsBtn">Clear All Meetings</button>
                    </div>
                    <div style="margin: 0.5rem 0;">
                        <label style="font-size: 0.9rem; color: #666;">Cross-Browser Connection:</label>
                        <div style="display: flex; gap: 0.5rem; margin-top: 0.3rem;">
                            <input type="text" id="manualMeetingId" placeholder="Enter Meeting ID" style="padding: 0.3rem; border: 1px solid #ccc; border-radius: 4px; flex: 1; font-size: 0.8rem;">
                            <button class="control-btn" id="forceJoinBtn" style="padding: 0.3rem 0.8rem; font-size: 0.8rem;">Force Connect</button>
                        </div>
                    </div>
                    <div id="meetingsList"></div>
                    <div id="storageInfo" style="font-size: 0.8rem; margin-top: 0.5rem; color: #666;"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class VideoCallApp {
            constructor() {
                this.localStream = null;
                this.remoteStream = null;
                this.peerConnection = null;
                this.isHost = false;
                this.meetingId = null;
                this.userName = '';
                this.participants = new Set();
                this.isVideoEnabled = true;
                this.isAudioEnabled = true;
                
                // For tracking meeting state
                this.meetingEnded = false;
                this.isConnected = false;
                
                // Initialize global storage for cross-session meeting data
                this.initializeGlobalStorage();
                this.initializeElements();
                this.setupEventListeners();
                this.setupWebRTC();
            }

            initializeGlobalStorage() {
                // Use localStorage for cross-tab communication
                this.signalingData = new Map();
                this.loadMeetingsFromStorage();
                
                // Listen for storage changes from other tabs
                window.addEventListener('storage', (e) => {
                    if (e.key === 'videocall_meetings') {
                        this.loadMeetingsFromStorage();
                        this.processSignalingMessages();
                    }
                });
                
                // Periodically sync with other tabs and process messages
                setInterval(() => {
                    this.loadMeetingsFromStorage();
                    this.processSignalingMessages();
                }, 1000);
            }

            initializeGlobalStorage() {
                // For cross-browser communication, we'll simulate a backend using a combination of approaches
                this.signalingData = new Map();
                
                // Try to load from multiple sources
                this.loadMeetingsFromAllSources();
                
                // Listen for storage changes (works within same browser only)
                window.addEventListener('storage', (e) => {
                    if (e.key === 'videocall_meetings') {
                        this.loadMeetingsFromAllSources();
                        this.checkMeetingStatus();
                        this.processSignalingMessages();
                    }
                });
                
                // Use a more aggressive sync approach for cross-browser
                setInterval(() => {
                    this.loadMeetingsFromAllSources();
                    this.checkMeetingStatus();
                    this.processSignalingMessages();
                    this.cleanupOldMeetings();
                }, 500); // Check every 500ms for better responsiveness

                // Listen for page unload (when user closes tab/browser)
                window.addEventListener('beforeunload', () => {
                    if (this.isHost && this.meetingId) {
                        this.endMeetingAsHost(false); // Silent end
                    }
                });
            }

            loadMeetingsFromAllSources() {
                try {
                    // Primary source: localStorage
                    const stored = localStorage.getItem('videocall_meetings');
                    if (stored) {
                        const meetingsData = JSON.parse(stored);
                        this.signalingData.clear();
                        Object.entries(meetingsData).forEach(([id, data]) => {
                            // Only load meetings that are less than 24 hours old
                            const ageInHours = (Date.now() - data.created) / (1000 * 60 * 60);
                            if (ageInHours < 24) {
                                this.signalingData.set(id, data);
                            }
                        });
                    }

                    // For cross-browser, we'll also use a global window property
                    // This won't work across browsers, but helps with debugging
                    if (window.globalMeetingStorage) {
                        window.globalMeetingStorage.forEach((value, key) => {
                            if (!this.signalingData.has(key)) {
                                this.signalingData.set(key, value);
                            }
                        });
                    }
                } catch (error) {
                    console.error('Error loading meetings from storage:', error);
                }
            }

            saveMeetingsToAllSources() {
                try {
                    const meetingsObj = {};
                    this.signalingData.forEach((value, key) => {
                        meetingsObj[key] = value;
                    });
                    
                    // Save to localStorage
                    localStorage.setItem('videocall_meetings', JSON.stringify(meetingsObj));
                    
                    // Also save to global window property
                    if (!window.globalMeetingStorage) {
                        window.globalMeetingStorage = new Map();
                    }
                    this.signalingData.forEach((value, key) => {
                        window.globalMeetingStorage.set(key, value);
                    });
                    
                    // Trigger storage event for same-browser tabs
                    window.dispatchEvent(new StorageEvent('storage', {
                        key: 'videocall_meetings',
                        newValue: JSON.stringify(meetingsObj)
                    }));
                } catch (error) {
                    console.error('Error saving meetings to storage:', error);
                }
            }

            cleanupOldMeetings() {
                let hasChanges = false;
                const now = Date.now();
                
                this.signalingData.forEach((meeting, id) => {
                    const ageInHours = (now - meeting.created) / (1000 * 60 * 60);
                    if (ageInHours > 24 || (!meeting.active && ageInHours > 1)) {
                        this.signalingData.delete(id);
                        hasChanges = true;
                    }
                });
                
                if (hasChanges) {
                    this.saveMeetingsToAllSources();
                }
            }

            initializeElements() {
                this.elements = {
                    roleSelection: document.getElementById('roleSelection'),
                    hostCard: document.getElementById('hostCard'),
                    joinCard: document.getElementById('joinCard'),
                    hostForm: document.getElementById('hostForm'),
                    joinForm: document.getElementById('joinForm'),
                    meetingInfo: document.getElementById('meetingInfo'),
                    videoContainer: document.getElementById('videoContainer'),
                    status: document.getElementById('status'),
                    localVideo: document.getElementById('localVideo'),
                    remoteVideo: document.getElementById('remoteVideo'),
                    remoteLabel: document.getElementById('remoteLabel'),
                    participantList: document.getElementById('participantList'),
                    displayMeetingId: document.getElementById('displayMeetingId')
                };
            }

            setupEventListeners() {
                // Role selection
                this.elements.hostCard.addEventListener('click', () => this.selectRole('host'));
                this.elements.joinCard.addEventListener('click', () => this.selectRole('join'));

                // Meeting actions
                document.getElementById('createMeetingBtn').addEventListener('click', () => this.createMeeting());
                document.getElementById('joinMeetingBtn').addEventListener('click', () => this.joinMeeting());
                document.getElementById('startCallBtn').addEventListener('click', () => this.startCall());

                // Call controls
                document.getElementById('toggleVideo').addEventListener('click', () => this.toggleVideo());
                document.getElementById('toggleAudio').addEventListener('click', () => this.toggleAudio());
                document.getElementById('endCall').addEventListener('click', () => this.endCall());

                // Debug controls
                document.getElementById('showMeetingsBtn').addEventListener('click', () => this.showAllMeetings());
                document.getElementById('createTestMeetingBtn').addEventListener('click', () => this.createTestMeeting());
                document.getElementById('clearMeetingsBtn').addEventListener('click', () => this.clearAllMeetings());
                document.getElementById('forceJoinBtn').addEventListener('click', () => this.forceJoinMeeting());

                // Update debug info periodically
                setInterval(() => this.updateDebugInfo(), 2000);
            }

            setupWebRTC() {
                const configuration = {
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' }
                    ]
                };

                this.peerConnection = new RTCPeerConnection(configuration);

                this.peerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        this.sendSignalingMessage({
                            type: 'ice-candidate',
                            candidate: event.candidate
                        });
                    }
                };

                this.peerConnection.ontrack = (event) => {
                    this.remoteStream = event.streams[0];
                    this.elements.remoteVideo.srcObject = this.remoteStream;
                    this.elements.remoteLabel.textContent = 'Participant';
                };

                this.peerConnection.onconnectionstatechange = () => {
                    const state = this.peerConnection.connectionState;
                    console.log('Connection state changed:', state);
                    this.showStatus(`Connection state: ${state}`, 'info');
                    
                    if (state === 'connected') {
                        this.showStatus('✅ Successfully connected to participant!', 'success');
                        this.elements.remoteLabel.textContent = this.isHost ? 'Participant' : 'Host';
                        document.getElementById('connectionStatus').innerHTML = '<p>✅ Connected successfully!</p>';
                        this.isConnected = true;
                    } else if (state === 'connecting') {
                        this.showStatus('🔄 Connecting...', 'info');
                        document.getElementById('connectionStatus').innerHTML = '<p>🔄 Establishing connection...</p>';
                    } else if (state === 'disconnected' || state === 'failed') {
                        this.isConnected = false;
                        if (!this.meetingEnded) {
                            this.showStatus('❌ Connection lost. Please try again.', 'error');
                            document.getElementById('connectionStatus').innerHTML = '<p>❌ Connection failed. Please refresh and try again.</p>';
                        }
                    }
                };
            }

            selectRole(role) {
                // Update UI
                document.querySelectorAll('.role-card').forEach(card => card.classList.remove('active'));
                document.querySelectorAll('.meeting-form').forEach(form => form.classList.remove('active'));

                if (role === 'host') {
                    this.elements.hostCard.classList.add('active');
                    this.elements.hostForm.classList.add('active');
                    this.isHost = true;
                } else {
                    this.elements.joinCard.classList.add('active');
                    this.elements.joinForm.classList.add('active');
                    this.isHost = false;
                }
            }

            generateMeetingId() {
                return Math.random().toString(36).substring(2, 8).toUpperCase();
            }

            createMeeting() {
                const hostName = document.getElementById('hostName').value.trim();
                if (!hostName) {
                    this.showStatus('Please enter your name', 'error');
                    return;
                }

                this.userName = hostName;
                this.meetingId = this.generateMeetingId();
                
                // Initialize meeting data in global storage
                this.signalingData.set(this.meetingId, {
                    host: hostName,
                    participants: [],
                    offers: [],
                    answers: [],
                    candidates: [],
                    created: Date.now(),
                    active: true,
                    hostPresent: true,
                    endedBy: null,
                    endedAt: null
                });

                // Save to persistent storage
                this.saveMeetingsToAllSources();

                // Show meeting info
                this.elements.displayMeetingId.textContent = this.meetingId;
                this.elements.roleSelection.style.display = 'none';
                this.elements.hostForm.classList.remove('active');
                this.elements.meetingInfo.classList.add('active');
                
                this.showStatus(`Meeting created successfully! Meeting ID: ${this.meetingId}`, 'success');
                
                // Auto-copy meeting ID to clipboard if supported
                if (navigator.clipboard && window.isSecureContext) {
                    navigator.clipboard.writeText(this.meetingId).then(() => {
                        console.log('Meeting ID copied to clipboard');
                    });
                }
                
                // Update debug info
                this.updateDebugInfo();
            }

            async joinMeeting() {
                const participantName = document.getElementById('participantName').value.trim();
                const meetingId = document.getElementById('meetingId').value.trim().toUpperCase();

                if (!participantName || !meetingId) {
                    this.showStatus('Please enter your name and meeting ID', 'error');
                    return;
                }

                // Force reload from storage before checking
                this.loadMeetingsFromAllSources();

                // Debug: Show all available meetings
                console.log('Available meetings:', Array.from(this.signalingData.keys()));
                console.log('Trying to join meeting:', meetingId);
                console.log('LocalStorage content:', localStorage.getItem('videocall_meetings'));

                // Check if meeting exists and is active
                if (!this.signalingData.has(meetingId)) {
                    // For cross-browser support, also check if user can manually create meeting data
                    const shouldCreateFallback = confirm(
                        `Meeting "${meetingId}" not found in this browser. \n\n` +
                        `This might be because the host created the meeting in a different browser. \n\n` +
                        `Would you like to try connecting anyway? \n` +
                        `(Click OK if you're sure the meeting exists)`
                    );
                    
                    if (shouldCreateFallback) {
                        // Create a placeholder meeting entry to allow connection attempt
                        this.signalingData.set(meetingId, {
                            host: 'Unknown Host',
                            participants: [],
                            offers: [],
                            answers: [],
                            candidates: [],
                            created: Date.now(),
                            active: true,
                            crossBrowser: true
                        });
                        this.saveMeetingsToAllSources();
                        this.showStatus(`Attempting to connect to meeting "${meetingId}"...`, 'info');
                    } else {
                        this.showStatus(`Meeting "${meetingId}" not found. Available meetings: ${Array.from(this.signalingData.keys()).join(', ') || 'None'}`, 'error');
                        return;
                    }
                } else {
                    const meetingData = this.signalingData.get(meetingId);
                    if (!meetingData.active) {
                        this.showStatus('This meeting has ended.', 'error');
                        return;
                    }
                }

                this.userName = participantName;
                this.meetingId = meetingId;

                // Add participant to meeting
                const meetingData = this.signalingData.get(meetingId);
                if (!meetingData.participants.includes(participantName)) {
                    meetingData.participants.push(participantName);
                    this.saveMeetingsToAllSources();
                }

                this.elements.roleSelection.style.display = 'none';
                this.elements.joinForm.classList.remove('active');
                
                await this.startCall();
                this.showStatus(`Successfully joined meeting "${meetingId}"!`, 'success');
            }

            async startCall() {
                try {
                    this.localStream = await navigator.mediaDevices.getUserMedia({
                        video: true,
                        audio: true
                    });

                    this.elements.localVideo.srcObject = this.localStream;
                    
                    // Add local stream to peer connection
                    this.localStream.getTracks().forEach(track => {
                        this.peerConnection.addTrack(track, this.localStream);
                    });

                    this.elements.videoContainer.classList.add('active');
                    this.elements.meetingInfo.classList.remove('active');

                    if (this.isHost) {
                        this.showStatus('🎯 Meeting started! Waiting for participants to join...', 'info');
                        // Host waits for offers from participants
                    } else {
                        // Participant creates and sends offer to host
                        this.showStatus('📡 Sending connection request to host...', 'info');
                        await this.createOffer();
                    }

                } catch (error) {
                    console.error('Error accessing media devices:', error);
                    this.showStatus('Error accessing camera/microphone. Please check permissions.', 'error');
                }
            }

            async createOffer() {
                try {
                    console.log('Creating offer...');
                    const offer = await this.peerConnection.createOffer();
                    await this.peerConnection.setLocalDescription(offer);
                    
                    this.sendSignalingMessage({
                        type: 'offer',
                        offer: offer,
                        to: 'host' // Participant sends offer to host
                    });

                    this.showStatus('📤 Connection offer sent to host...', 'info');
                } catch (error) {
                    console.error('Error creating offer:', error);
                    this.showStatus('❌ Error creating connection offer', 'error');
                }
            }

            async handleOffer(offer) {
                try {
                    console.log('Handling offer from participant...');
                    await this.peerConnection.setRemoteDescription(offer);
                    const answer = await this.peerConnection.createAnswer();
                    await this.peerConnection.setLocalDescription(answer);
                    
                    this.sendSignalingMessage({
                        type: 'answer',
                        answer: answer,
                        to: 'participant' // Host sends answer to participant
                    });

                    this.showStatus('📥 Connection request received! Sending response...', 'success');
                    document.getElementById('connectionStatus').innerHTML = '<p>📥 Participant joined! Establishing connection...</p>';
                } catch (error) {
                    console.error('Error handling offer:', error);
                    this.showStatus('❌ Error handling connection offer', 'error');
                }
            }

            async handleAnswer(answer) {
                try {
                    console.log('Handling answer from host...');
                    await this.peerConnection.setRemoteDescription(answer);
                    this.showStatus('📨 Response received from host! Establishing connection...', 'success');
                    document.getElementById('connectionStatus').innerHTML = '<p>📨 Host responded! Finalizing connection...</p>';
                } catch (error) {
                    console.error('Error handling answer:', error);
                    this.showStatus('❌ Error handling connection answer', 'error');
                }
            }

            async handleIceCandidate(candidate) {
                try {
                    console.log('Adding ICE candidate...');
                    await this.peerConnection.addIceCandidate(candidate);
                } catch (error) {
                    console.error('Error adding ICE candidate:', error);
                }
            }

            sendSignalingMessage(message) {
                const meetingData = this.signalingData.get(this.meetingId);
                if (!meetingData) {
                    console.error('Meeting not found:', this.meetingId);
                    return;
                }

                message.from = this.userName;
                message.fromRole = this.isHost ? 'host' : 'participant';
                message.timestamp = Date.now();
                message.id = Math.random().toString(36).substring(2, 15);

                console.log('Sending signaling message:', message.type, 'from', message.fromRole);

                // Add message to appropriate queue
                switch (message.type) {
                    case 'offer':
                        meetingData.offers.push(message);
                        break;
                    case 'answer':
                        meetingData.answers.push(message);
                        break;
                    case 'ice-candidate':
                        meetingData.candidates.push(message);
                        break;
                }

                // Save changes to storage
                this.saveMeetingsToAllSources();
            }

            processSignalingMessages() {
                if (!this.meetingId || !this.signalingData.has(this.meetingId)) return;
                
                const meetingData = this.signalingData.get(this.meetingId);
                let hasChanges = false;

                // Process offers (host processes offers from participants)
                if (this.isHost && meetingData.offers.length > 0) {
                    const offer = meetingData.offers.shift();
                    if (offer.fromRole === 'participant' && offer.from !== this.userName) {
                        console.log('Host processing offer from participant:', offer.from);
                        this.handleOffer(offer.offer);
                        hasChanges = true;
                    }
                }

                // Process answers (participant processes answers from host)
                if (!this.isHost && meetingData.answers.length > 0) {
                    const answer = meetingData.answers.shift();
                    if (answer.fromRole === 'host' && answer.from !== this.userName) {
                        console.log('Participant processing answer from host:', answer.from);
                        this.handleAnswer(answer.answer);
                        hasChanges = true;
                    }
                }

                // Process ICE candidates and meeting signals
                if (meetingData.candidates.length > 0) {
                    const messages = [...meetingData.candidates];
                    meetingData.candidates = [];
                    
                    messages.forEach(message => {
                        if (message.from !== this.userName) {
                            if (message.type === 'ice-candidate') {
                                console.log('Processing ICE candidate from:', message.from);
                                this.handleIceCandidate(message.candidate);
                                hasChanges = true;
                            } else if (message.type === 'meeting-ended' && message.fromRole === 'host' && !this.isHost) {
                                console.log('Received meeting ended signal from host');
                                // This will be handled by checkMeetingStatus
                                hasChanges = true;
                            }
                        }
                    });
                }

                // Save changes if any messages were processed
                if (hasChanges) {
                    this.saveMeetingsToAllSources();
                }
            }



            toggleVideo() {
                this.isVideoEnabled = !this.isVideoEnabled;
                const videoTrack = this.localStream.getVideoTracks()[0];
                if (videoTrack) {
                    videoTrack.enabled = this.isVideoEnabled;
                }
                
                const btn = document.getElementById('toggleVideo');
                btn.textContent = this.isVideoEnabled ? '📹 Video' : '📹 Video (Off)';
                btn.style.opacity = this.isVideoEnabled ? '1' : '0.5';
            }

            toggleAudio() {
                this.isAudioEnabled = !this.isAudioEnabled;
                const audioTrack = this.localStream.getAudioTracks()[0];
                if (audioTrack) {
                    audioTrack.enabled = this.isAudioEnabled;
                }
                
                const btn = document.getElementById('toggleAudio');
                btn.textContent = this.isAudioEnabled ? '🎤 Audio' : '🎤 Audio (Off)';
                btn.style.opacity = this.isAudioEnabled ? '1' : '0.5';
            }

            endCall() {
                if (this.isHost) {
                    // Confirm before ending meeting for all participants
                    const confirmEnd = confirm(
                        "Are you sure you want to end this meeting?\n\n" +
                        "This will disconnect all participants and cannot be undone."
                    );
                    
                    if (confirmEnd) {
                        this.endMeetingAsHost(true);
                    }
                } else {
                    // Participant can leave without confirmation
                    this.endCallAsParticipant();
                }
            }

            endMeetingAsHost(showMessage = true) {
                this.meetingEnded = true;
                
                // Mark meeting as ended by host
                if (this.meetingId && this.signalingData.has(this.meetingId)) {
                    const meetingData = this.signalingData.get(this.meetingId);
                    meetingData.active = false;
                    meetingData.hostPresent = false;
                    meetingData.endedBy = 'host';
                    meetingData.endedAt = Date.now();
                    
                    // Send end meeting signal to all participants
                    meetingData.candidates.push({
                        type: 'meeting-ended',
                        from: this.userName,
                        fromRole: 'host',
                        timestamp: Date.now(),
                        reason: 'Host ended the meeting'
                    });
                    
                    this.saveMeetingsToAllSources();
                }

                this.cleanupConnection();
                
                if (showMessage) {
                    this.showStatus('📞 Meeting ended by host', 'info');
                }
            }

            endCallAsParticipant() {
                this.meetingEnded = true;
                
                // Remove participant from meeting
                if (this.meetingId && this.signalingData.has(this.meetingId)) {
                    const meetingData = this.signalingData.get(this.meetingId);
                    meetingData.participants = meetingData.participants.filter(p => p !== this.userName);
                    this.saveMeetingsToAllSources();
                }

                this.cleanupConnection();
                this.showStatus('📞 You left the meeting', 'info');
            }

            cleanupConnection() {
                // Stop local stream
                if (this.localStream) {
                    this.localStream.getTracks().forEach(track => track.stop());
                }
                
                // Close peer connection
                if (this.peerConnection) {
                    this.peerConnection.close();
                    this.setupWebRTC(); // Reinitialize for next call
                }

                // Reset UI
                this.resetUI();
            }

            resetUI() {
                this.elements.videoContainer.classList.remove('active');
                this.elements.roleSelection.style.display = 'flex';
                this.elements.meetingInfo.classList.remove('active');
                
                // Reset forms
                document.querySelectorAll('.role-card').forEach(card => card.classList.remove('active'));
                document.querySelectorAll('.meeting-form').forEach(form => form.classList.remove('active'));
                
                // Clear input fields
                document.getElementById('hostName').value = '';
                document.getElementById('participantName').value = '';
                document.getElementById('meetingId').value = '';
                
                // Reset connection status
                document.getElementById('connectionStatus').innerHTML = '<p>🔄 Waiting for connection...</p>';
                this.elements.remoteLabel.textContent = 'Waiting for participant...';
                
                // Clear remote video
                this.elements.remoteVideo.srcObject = null;
                this.elements.localVideo.srcObject = null;
            }

            checkMeetingStatus() {
                if (!this.meetingId || this.meetingEnded) return;
                
                const meetingData = this.signalingData.get(this.meetingId);
                if (!meetingData) return;

                // Check if host ended the meeting
                if (!this.isHost && (!meetingData.active || meetingData.endedBy === 'host')) {
                    this.meetingEnded = true;
                    this.cleanupConnection();
                    this.showStatus('📞 Meeting ended by host', 'error');
                    
                    // Show meeting ended message
                    document.getElementById('connectionStatus').innerHTML = '<p>📞 Meeting was ended by the host</p>';
                    
                    setTimeout(() => {
                        this.resetUI();
                    }, 3000);
                    return;
                }

                // Check for meeting-ended signals
                if (meetingData.candidates) {
                    const endSignal = meetingData.candidates.find(c => 
                        c.type === 'meeting-ended' && c.fromRole === 'host' && c.from !== this.userName
                    );
                    
                    if (endSignal && !this.isHost) {
                        this.meetingEnded = true;
                        this.cleanupConnection();
                        this.showStatus('📞 Meeting ended by host', 'error');
                        
                        setTimeout(() => {
                            this.resetUI();
                        }, 3000);
                    }
                }
            }

            updateDebugInfo() {
                const activeMeetingsCount = Array.from(this.signalingData.values())
                    .filter(meeting => meeting.active).length;
                document.getElementById('activeMeetings').textContent = activeMeetingsCount;
                
                // Show storage info
                const storageInfo = document.getElementById('storageInfo');
                const storageData = localStorage.getItem('videocall_meetings');
                if (storageInfo) {
                    storageInfo.textContent = `Storage: ${storageData ? 'Has data' : 'Empty'} | Total meetings: ${this.signalingData.size}`;
                }
            }

            showAllMeetings() {
                const meetingsList = document.getElementById('meetingsList');
                const isVisible = meetingsList.style.display === 'block';
                
                if (isVisible) {
                    meetingsList.style.display = 'none';
                    document.getElementById('showMeetingsBtn').textContent = 'Show All Meetings';
                } else {
                    let html = '<strong>All Meetings:</strong><br>';
                    
                    if (this.signalingData.size === 0) {
                        html += 'No meetings found.';
                    } else {
                        this.signalingData.forEach((meeting, id) => {
                            const status = meeting.active ? '🟢 Active' : '🔴 Ended';
                            const time = new Date(meeting.created).toLocaleTimeString();
                            html += `${id}: ${status} (Host: ${meeting.host}, Created: ${time})<br>`;
                        });
                    }
                    
                    meetingsList.innerHTML = html;
                    meetingsList.style.display = 'block';
                    document.getElementById('showMeetingsBtn').textContent = 'Hide Meetings';
                }
            }

            createTestMeeting() {
                // Create a test meeting for debugging
                const testId = 'TEST' + Math.random().toString(36).substring(2, 5).toUpperCase();
                this.signalingData.set(testId, {
                    host: 'Test Host',
                    participants: [],
                    offers: [],
                    answers: [],
                    candidates: [],
                    created: Date.now(),
                    active: true
                });
                this.saveMeetingsToStorage();
                this.showStatus(`✅ Test meeting created: ${testId}`, 'success');
                this.updateDebugInfo();
            }

            clearAllMeetings() {
                this.signalingData.clear();
                localStorage.removeItem('videocall_meetings');
                if (window.globalMeetingStorage) {
                    window.globalMeetingStorage.clear();
                }
                this.showStatus('🗑️ All meetings cleared', 'info');
                this.updateDebugInfo();
            }

            showStatus(message, type) {
                const statusEl = this.elements.status;
                statusEl.textContent = message;
                statusEl.className = `status ${type}`;
                
                if (type !== 'info') {
                    setTimeout(() => {
                        statusEl.style.display = 'none';
                    }, 5000);
                }
            }
        }

        // Initialize the app when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new VideoCallApp();
        });
    </script>
</body>
</html>